<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Tutorial Request - SkillBridge</title>
    <link rel="stylesheet" href="css/style22.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <a href="index.html">
                    Skill<span class="logo-accent">Bridge</span>
                </a>
            </div>
            <div class="main-menu">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li class="dropdown">
                        <a href="#">Surfaces</a>
                        <div class="dropdown-content">
                            <a href="Skillswapsearchpage.html"><i class="fas fa-laptop"></i>Skill Swap</a>
                            <a href="online-tutorial request.html"><i class="fas fa-chalkboard-teacher"></i>Online Tutorial</a>
                            <a href="event.html"><i class="fas fa-calendar-alt"></i> Upcoming Events</a>
                        </div>
                    </li>
                    <li><a href="aboutus.html">About Us</a></li>
                    <li><a href="contactus.html">Contact Us</a></li>
                    <li><a href="signup.html" class="btn" id="signup-btn"><i class="fas fa-user"></i> Sign Up</a></li>
                    <li><a href="login.html" class="btn" id="login-btn"><i class="fas fa-sign-in-alt"></i> Log In</a></li>
                </ul>
            </div>
            <button class="hamburger-button">
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
            </button>
            <div class="sidebar">
                <div class="sidebar-header">
                    <button type="button" class="close-sidebar">&times;</button>
                </div>
                <div class="sidebar-content">
                    <div class="menu-section">
                        <a href="profilepage.html"><i class="fas fa-user"></i> Personal Details</a>
                        <a href="payment.html"><i class="fas fa-crown"></i> Subscriptions</a>
                        <a href="Skillswapsearchpage.html"><i class="fas fa-exchange-alt"></i> Swap Skill</a>
                        <a href="chatspage.html"><i class="fas fa-envelope"></i> Messages</a>
                        <a href="online-tutorial request.html"><i class="fas fa-chalkboard-teacher"></i> Online Tutorial</a>
                        <a href="my-tutorials.html"><i class="fas fa-chalkboard-teacher"></i> My Tutorials</a>
                        <a href="event.html"><i class="fas fa-calendar-alt"></i> Upcoming Events</a>
                        <a href="my-events.html"><i class="fas fa-calendar-check"></i> My Events</a>
                        <a href="Skillswap.html" role="button"><i class="fas fa-history"></i> Skills SwapHistory</a>
                        <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
                    </div>
                    <div class="sidebar-section-title">Privacy Policy-Terms of Service</div>
                    <div class="menu-section support-section">
                        <a href="#" role="button"><i class="fas fa-question-circle"></i> Help & Feedback</a>
                        <a href="login.html" class="login-btn"><i class="fas fa-sign-in-alt"></i> Log In</a>
                        <a href="signup.html" class="signup-btn"><i class="fas fa-user-plus"></i> Sign Up</a>
                        <a href="#" class="signout-btn" style="display: none;"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <div class="ss-skillswap-search-page">
        <div class="ss-container">
            <h1>Find Your Online Tutorial</h1>
            <div class="ss-search-section">
                <div class="form-group">
                    <input type="text" id="tutorialSearch" placeholder="Search for a tutorial..." class="form-control">
                </div>
                <div class="ss-filters">
                    <select id="levelFilter" class="ss-filter-select">
                        <option value="">All Levels</option>
                        <option value="Beginner">Beginner</option>
                        <option value="Intermediate">Intermediate</option>
                        <option value="Advanced">Advanced</option>
                    </select>
                    <button id="clearBtn" class="ss-clear-btn">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
            <div id="tutorialResults" class="ss-user-results">
                <!-- Sample Tutorial Card -->
                <!-- REMOVE ALL HARDCODED SAMPLE CARDS BELOW, ONLY DYNAMIC CARDS SHOULD BE RENDERED BY JS -->
            </div>
            <div id="loading" class="ss-loading">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
        </div>
    </div>
    <script type="module">
    import subscriptionModal from './js/subscription-modal.js';

    // Function to check subscription status
    async function checkSubscription() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }

            const response = await fetch('http://localhost:5000/api/subscription-status', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                subscriptionModal.show();
                return false;
            }

            return true;
        } catch (error) {
            console.error('Error checking subscription:', error);
            return false;
        }
    }

    // Modify the enroll button click handler
    document.querySelectorAll('.enroll-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.preventDefault();
            if (await checkSubscription()) {
                // Proceed with enrollment
                const tutorialId = e.target.dataset.tutorialId;
                // ... existing enrollment code ...
            }
        });
    });

    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tutorials
        renderTutorials();
        
        // Add event listeners for search and filters
        const searchInput = document.getElementById('tutorialSearch');
        const levelFilter = document.getElementById('levelFilter');
        const clearBtn = document.getElementById('clearBtn');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                renderTutorials(this.value);
            });
        }
        if (levelFilter) {
            levelFilter.addEventListener('change', function() {
                renderTutorials(searchInput ? searchInput.value : '');
            });
        }
        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                if (searchInput) searchInput.value = '';
                if (levelFilter) levelFilter.value = '';
                renderTutorials();
            });
        }
        // Add event delegation for tutorial card buttons
        document.getElementById('tutorialResults').addEventListener('click', function(e) {
            const contactBtn = e.target.closest('.contact-btn');
            
            if (contactBtn) {
                const tutorialCard = contactBtn.closest('.tutorial-card');
                const instructorId = tutorialCard.dataset.instructorId;
                if (instructorId) {
                    window.location.href = `chatspage.html?user=${instructorId}`;
                }
            }
        });
    });
    async function fetchTutorials(searchQuery = '', levelFilter = '') {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('No authentication token found');
                return [];
            }
            const response = await fetch(`http://localhost:5000/api/tutorials?search=${encodeURIComponent(searchQuery)}&level=${encodeURIComponent(levelFilter)}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching tutorials:', error);
            return [];
        }
    }
    function createTutorialCard(tutorial) {
        return `
            <div class="tutorial-card" data-tutorial-id="${tutorial.id}" data-instructor-id="${tutorial.created_by}">
                <div class="tutorial-image">
                    <img src="${tutorial.image}" alt="${tutorial.title}" loading="lazy" onerror="this.onerror=null; this.src='Images/online tutorials/graphic.jpg';">
                    <div class="tutorial-level-badge">${tutorial.level}</div>
                </div>
                <div class="tutorial-content">
                    <h3>${tutorial.title}</h3>
                    <p class="tutorial-description">${tutorial.description}</p>
                    <div class="tutorial-meta">
                        <div class="meta-item">
                            <i class="fas fa-clock"></i>
                            <span>${tutorial.duration}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-user"></i>
                            <span>${tutorial.instructor_name || tutorial.instructor}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-star"></i>
                            <span>${tutorial.rating}</span>
                        </div>
                    </div>
                    <div class="tutorial-actions">
                        <a href="tutorial-details.html?id=${tutorial.id}" class="primary-btn enroll-btn" data-tutorial-id="${tutorial.id}">
                            <i class="fas fa-play"></i>
                            <span>Start Learning</span>
                        </a>
                        
                    </div>
                </div>
            </div>
        `;
    }
    async function renderTutorials(searchTerm = '') {
        const resultsContainer = document.getElementById('tutorialResults');
        const loadingElement = document.getElementById('loading');
        
        try {
            loadingElement.style.display = 'block';
            resultsContainer.innerHTML = '';
            const levelFilter = document.getElementById('levelFilter').value;
            const tutorials = await fetchTutorials(searchTerm, levelFilter);
            // Filter out tutorials with invalid IDs (less than 11)
            const validTutorials = tutorials.filter(tutorial => Number(tutorial.id) >= 11);
            if (validTutorials.length === 0) {
                resultsContainer.innerHTML = '<p class="no-results">No tutorials found matching your criteria.</p>';
                return;
            }
            validTutorials.forEach(tutorial => {
                resultsContainer.innerHTML += createTutorialCard(tutorial);
            });
        } catch (error) {
            console.error('Error:', error);
            resultsContainer.innerHTML = '<p class="error-message">Error loading tutorials. Please try again later.</p>';
        } finally {
            loadingElement.style.display = 'none';
        }
    }
    async function handleStartLearning(tutorialId) {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please log in to access tutorial content');
                window.location.href = 'login.html';
                return;
            }
            // Check if user is enrolled
            const response = await fetch(`http://localhost:5000/api/tutorials/${tutorialId}/enrollment-status`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (!response.ok) {
                throw new Error('Failed to check enrollment status');
            }
            const { is_enrolled } = await response.json();
            if (is_enrolled) {
                // If enrolled, navigate to tutorial content page with the tutorial ID
                window.location.href = `tutorial-content.html?id=${tutorialId}`;
            } else {
                // If not enrolled, navigate to tutorial details page
                window.location.href = `tutorial-details.html?id=${tutorialId}`;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error checking enrollment status. Please try again later.');
        }
    }
    async function contactInstructor(tutorialId) {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please log in to chat with the instructor');
                window.location.href = 'login.html';
                return;
            }

            // Get the tutorial details to find the instructor ID
            const response = await fetch(`http://localhost:5000/api/tutorials/${tutorialId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch tutorial details');
            }

            const tutorial = await response.json();
            if (tutorial.created_by) {
                window.location.href = `chatspage.html?user=${tutorial.created_by}`;
            } else {
                alert('Instructor information not available');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error contacting instructor. Please try again later.');
        }
    }
    </script>
    
    <!-- Authentication Scripts -->
    <script src="js/api.js"></script> 
    <script src="js/auth.js"></script>
    <script src="js/auth-init.js"></script>
    <script src="js/login-guard.js"></script>

    <script src="js/fixed_merged_main.js"></script>
    
    
    
   
</body>
</html>
